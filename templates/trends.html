<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Glucose Trends</title>
	<link rel="icon" type="image/png" href="{{ url_for('static', filename='icon.png') }}">
	<link rel="apple-touch-icon" href="{{ url_for('static', filename='icon.png') }}">
	<link rel="manifest" href="{{ url_for('static', filename='manifest.json') }}">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.3.0/dist/chart.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
    <style>
        body { background: #f0f2f5; padding: 20px 10px; font-family: sans-serif; }
        .stats-card { background: #fff; border-radius: 16px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        .chart-box { height: 350px; position: relative; }
        .mini-chart { height: 250px; position: relative; }
    </style>
</head>
<body>
    <div class="container" style="max-width: 1100px;">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2>üìä Trends Analysis</h2>
            <div>
                <a href="/meals" class="btn btn-outline-primary btn-sm">Meal History</a>
                <a href="/" class="btn btn-outline-secondary btn-sm">Dashboard</a>
            </div>
        </div>

        <div class="stats-card">
            <div class="d-flex justify-content-between mb-2">
                <h5>Glucose History & Meals</h5>
                <select id="timeframe" class="form-select w-auto form-select-sm">
                    <option value="1440">24 Hours</option>
                    <option value="10080" selected>7 Days</option>
                    <option value="43200">30 Days</option>
                </select>
            </div>
            <div class="chart-box"><canvas id="mainChart"></canvas></div>
        </div>

        <div class="row">
            <div class="col-md-6">
                <div class="stats-card">
                    <h5>üçû Carbs vs. Glucose Rise</h5>
                    <p class="text-muted small">Do more carbs always equal higher spikes?</p>
                    <div class="mini-chart"><canvas id="carbChart"></canvas></div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="stats-card">
                    <h5>üéØ Time In Range</h5>
                    <p class="text-muted small">Target: 70 - 180 mg/dL</p>
                    <div class="mini-chart"><canvas id="rangeChart"></canvas></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let charts = {};

        async function load() {
            const mins = document.getElementById('timeframe').value;
            const step = mins > 43200 ? 12 : (mins > 1440 ? 6 : 1);

            const [readingsRes, mealsRes] = await Promise.all([
                fetch(`/api/readings?minutes=${mins}&step=${step}`),
                fetch('/api/meals')
            ]);

            const readings = await readingsRes.json();
            const allMeals = await mealsRes.json();

            // Filter meals to window
            const cutoff = new Date(Date.now() - (mins * 60000));
            const meals = allMeals.filter(m => new Date(m.timestamp) > cutoff);

            renderMainChart(readings, meals);
            renderRangeChart(readings);
            renderCarbChart(allMeals); // Use ALL meals for better data points
        }

        function renderMainChart(readings, meals) {
            if(charts.main) charts.main.destroy();
            const mealPoints = meals.map(m => {
                // Align meal dot to closest glucose reading time
                const mTime = new Date(m.timestamp).getTime();
                const closest = readings.reduce((p, c) => Math.abs(new Date(c.timestamp)-mTime) < Math.abs(new Date(p.timestamp)-mTime) ? c : p);
                return { x: m.timestamp, y: closest ? closest.mg_dl : 100, type: m.type, items: m.items.join(', ') };
            });

            charts.main = new Chart(document.getElementById('mainChart'), {
                type: 'line',
                data: {
                    datasets: [
                        { label: 'Glucose', data: readings.map(r=>({x:r.timestamp, y:r.mg_dl})), borderColor: '#0047AB', backgroundColor: 'rgba(0,71,171,0.1)', fill: true, pointRadius: 0 },
                        { label: 'Meals', data: mealPoints, type: 'scatter', backgroundColor: '#FF8C00', pointRadius: 6 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { type: 'time', time: { displayFormats: { day: 'MMM d' } } } },
                    plugins: { tooltip: { callbacks: { label: c => c.dataset.type==='scatter' ? `üçΩÔ∏è ${c.raw.type}: ${c.raw.items}` : `${c.parsed.y} mg/dL` } } }
                }
            });
        }

        function renderRangeChart(readings) {
            if(charts.range) charts.range.destroy();
            const vals = readings.map(r => r.mg_dl);
            const low = vals.filter(v=>v<70).length;
            const high = vals.filter(v=>v>180).length;
            const ok = vals.length - low - high;

            charts.range = new Chart(document.getElementById('rangeChart'), {
                type: 'doughnut',
                data: { labels: ['Low', 'In Range', 'High'], datasets: [{ data: [low, ok, high], backgroundColor: ['#dc3545', '#28a745', '#ffc107'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function renderCarbChart(meals) {
            if(charts.carb) charts.carb.destroy();
            // X: Carbs, Y: Rise. Only use meals with carb data.
            const data = meals.filter(m => m.carbs > 0).map(m => ({ x: m.carbs, y: m.analysis.rise, items: m.items.join(', ') }));

            charts.carb = new Chart(document.getElementById('carbChart'), {
                type: 'scatter',
                data: { datasets: [{ label: 'Meal Impact', data: data, backgroundColor: '#6f42c1' }] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: { x: { title: {display:true, text:'Carbs (g)'} }, y: { title: {display:true, text:'Glucose Rise (mg/dL)'} } },
                    plugins: { tooltip: { callbacks: { label: c => `${c.raw.items}: ${c.raw.x}g carbs ‚û° +${c.raw.y} mg/dL` } } }
                }
            });
        }

        document.getElementById('timeframe').addEventListener('change', load);
        load();
    </script>
</body>
</html>
